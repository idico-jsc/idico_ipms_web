name: CD - Continuous Deployment

on:
  workflow_run:
    workflows: ["CI - Continuous Integration"] 
    types:
      - completed
env:
  DOCKER_IMAGE: cdsidico/idico-ipms-web

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password:  ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |   
            echo "ðŸš€ Starting deployment..."

            echo "ðŸ“¦ Pulling latest Docker image..."
            docker-compose pull

            echo "ðŸ”„ Restarting services..."
            docker-compose up -d --remove-orphans

            echo "â³ Waiting for services to be healthy..."
            sleep 10

            echo "ðŸ“Š Service status:"
            docker-compose ps

            echo "âœ… Deployment successful!"

      - name: Deployment Summary
        if: success()
        run: |
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Services have been updated and are running on the server." >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs and server status." >> $GITHUB_STEP_SUMMARY
